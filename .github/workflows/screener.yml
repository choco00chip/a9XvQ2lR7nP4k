name: Daily Stock Screening

on:
  schedule:
    - cron: '0 22 * * 1-5'   # æ¯æ—¥ 07:00 JSTï¼ˆæœˆã€œé‡‘ï¼‰ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
    - cron: '0 20 1 * *'      # æ¯æœˆ1æ—¥ 05:00 JST ãƒ†ã‚£ãƒƒã‚«ãƒ¼æ›´æ–°
  workflow_dispatch:
    inputs:
      update_tickers:
        description: 'Russell 2000ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ã™ã‚‹'
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ============================================================
  # Job 1: Russell 2000ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆæœˆæ¬¡ or æ‰‹å‹•ï¼‰
  # ============================================================
  update_tickers:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule' && contains(github.event.schedule, '0 20 1')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.update_tickers == 'true')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests beautifulsoup4 lxml
      - name: Russell 2000ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
        run: python update_russell2000.py
      - name: æ›´æ–°çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config user.email "bot@github.com"
          git config user.name "Screener Bot"
          git add russell2000.txt
          git diff --staged --quiet || (
            git commit -m "ğŸ“‹ Russell 2000ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–° $(date +'%Y-%m')" &&
            git pull --rebase origin main &&
            git push
          )

  # ============================================================
  # Job 2: æ¯æ—¥ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
  # update_tickersãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆã¯å¿…ãšãã®å¾Œã«å®Ÿè¡Œï¼ˆç›´åˆ—åŒ–ï¼‰
  # ============================================================
  screen:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    needs: [update_tickers]
    if: |
      always() &&
      (needs.update_tickers.result == 'success' || needs.update_tickers.result == 'skipped') &&
      (
        (github.event_name == 'schedule' && contains(github.event.schedule, '0 22')) ||
        (github.event_name == 'schedule' && contains(github.event.schedule, '0 20 1')) ||
        github.event_name == 'workflow_dispatch'
      )
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install yfinance pandas numpy requests lxml html5lib beautifulsoup4
      - name: russell2000.txtã®ç¢ºèª
        run: |
          if [ -f russell2000.txt ]; then
            COUNT=$(wc -l < russell2000.txt)
            echo "âœ… russell2000.txt: ${COUNT}éŠ˜æŸ„"
          else
            echo "âš ï¸  russell2000.txt ãªã— â†’ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å‹•ä½œ"
          fi
      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œ
        run: python screener_v4.py --mode full
      - name: çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config user.email "bot@github.com"
          git config user.name "Screener Bot"
          git add docs/
          git diff --staged --quiet || (
            git commit -m "ğŸ“Š ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ›´æ–° $(date +'%Y-%m-%d')" &&
            git pull --rebase origin main &&
            git push
          )

  # ============================================================
  # Job 3: GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
  # ============================================================
  deploy:
    needs: screen
    runs-on: ubuntu-latest
    if: always() && needs.screen.result == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - uses: actions/configure-pages@v4
      - uses: actions/upload-pages-artifact@v3
        with:
          path: docs/
      - id: deployment
        uses: actions/deploy-pages@v4
