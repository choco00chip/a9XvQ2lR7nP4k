<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>StockScreen</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#060a10;color:#ddeeff;font-family:monospace;font-size:13px}
#app{min-height:100vh}
.topbar{position:sticky;top:0;z-index:100;background:#060a10;border-bottom:1px solid #0e1c30;padding:9px 14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.logo{font-family:sans-serif;font-size:19px;font-weight:800}
.logo span{color:#00e5ff}
.meta{font-size:10px;color:#2a4a6a;line-height:1.7}
.meta .time{color:#00e5ff}
.search{background:#0a1320;border:1px solid #0e1c30;border-radius:8px;padding:6px 11px;color:#ddeeff;font-family:monospace;font-size:13px;width:140px;outline:none}
.btn{background:#0a1320;border:1px solid #0e1c30;border-radius:6px;padding:5px 10px;color:#4a6a88;font-size:12px;cursor:pointer}
.btn:hover{border-color:#00e5ff;color:#00e5ff}
.layout{display:flex;max-width:1900px;margin:0 auto}
.sidebar{width:180px;flex-shrink:0;padding:14px 12px;border-right:1px solid #0e1c30;display:flex;flex-direction:column;gap:13px}
.sidebar-title{font-size:10px;color:#1e3450;text-transform:uppercase;letter-spacing:.1em}
.filter-row{display:flex;justify-content:space-between;margin-bottom:4px}
.filter-label{font-size:11px;color:#4a6a88}
.filter-val{font-size:11px;color:#00e5ff;font-weight:700}
input[type=range]{width:100%;accent-color:#00e5ff;cursor:pointer}
.reset-btn{background:none;border:1px solid #0e1c30;border-radius:6px;color:#4a6a88;padding:5px 0;font-size:12px;cursor:pointer;width:100%}
.macro{border-top:1px solid #0e1c30;padding-top:11px}
.macro-mode{font-size:13px;font-weight:700;color:#ddeeff;margin-bottom:5px}
.macro-vix{font-size:12px;color:#f0d060;margin-bottom:6px}
.macro-etf{font-size:11px;margin-bottom:3px}
.score-legend{border-top:1px solid #0e1c30;padding-top:9px;font-size:10px;color:#2a4a6a;line-height:2.1}
.score-legend .leg-title{color:#4a6a88;margin-bottom:3px}
.main{flex:1;padding:11px 13px;min-width:0}
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:11px}
.card{background:#0a1320;border:1px solid #0e1c30;border-radius:10px;padding:9px 13px}
.card-label{font-size:10px;color:#2a4a6a;text-transform:uppercase;margin-bottom:3px}
.card-val{font-size:24px;font-weight:500;font-family:sans-serif}
.detail{background:rgba(0,255,140,.04);border:1px solid rgba(0,255,140,.18);border-radius:12px;padding:13px 17px;margin-bottom:11px}
.detail-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:11px}
.detail-ticker{font-family:sans-serif;font-size:24px;font-weight:800;color:#00ff88;margin-right:8px}
.detail-close{background:none;border:none;color:#4a6a88;font-size:17px;cursor:pointer}
.detail-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px}
.detail-cell{background:#0a1320;border:1px solid #0e1c30;border-radius:8px;padding:7px 11px;text-align:center}
.detail-cell-label{font-size:10px;color:#2a4a6a;margin-bottom:3px}
.detail-cell-val{font-size:14px;font-weight:500}
.tbl-wrap{background:#0a1320;border:1px solid #0e1c30;border-radius:12px;overflow:hidden}
.tbl-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
thead tr{background:#060a10;border-bottom:1px solid #0e1c30}
th{padding:8px 9px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#1e3a5a;cursor:pointer;user-select:none;white-space:nowrap;text-align:right}
th.left{text-align:left}
th.active{color:#00e5ff;background:rgba(0,229,255,.05);border-bottom:2px solid #00e5ff}
tbody tr{cursor:pointer}
tbody tr:hover{background:rgba(0,180,255,.06)}
tbody tr.sel{background:rgba(0,255,140,.05)}
td{padding:7px 9px;border-bottom:1px solid rgba(14,28,48,.6);white-space:nowrap;text-align:right}
td.left{text-align:left}
.rs-badge{display:inline-block;border-radius:5px;padding:2px 8px;font-size:13px;font-weight:700}
.score-badge{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:700}
.footer{margin-top:7px;font-size:10px;color:#1e3450;display:flex;justify-content:space-between}
.center-msg{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:12px}
</style>
</head>
<body>
<div id="app"><div class="center-msg"><div style="color:#00e5ff;font-size:15px">Ë™≠„ÅøËæº„Åø‰∏≠...</div></div></div>
<script>
function rsCol(v){return v>=90?"#00ff88":v>=80?"#7dff9e":v>=70?"#f0d060":v>=55?"#ff9933":"#ff4444";}
function numCol(v){return v>5?"#00e676":v>0?"#69f0ae":v<-5?"#ff5252":v<0?"#ff8a80":"#607d8b";}
function vcsCol(v){return v>=80?"#00ff88":v>=60?"#00e676":v>=40?"#2962ff":"#607d8b";}
function emaCol(v){return v<=3?"#00ff88":v<=8?"#00e676":"#f0d060";}
function atrCol(v){return v<=3?"#00ff88":v<=7?"#00e676":"#f0d060";}
function fmtRS(v){return v==null?"‚Äî":Number(v).toFixed(1);}
function fmtN(v){return v==null?"‚Äî":(v>0?"+":"")+Number(v).toFixed(1)+"%";}
function fmtV(v){return v==null?"‚Äî":Number(v).toFixed(1);}
function scoreLabel(s){return s>=8?{t:"‚óé ÊúÄÊúâÂäõ",c:"#00ff88"}:s>=6?{t:"‚óã ÊúâÂäõ",c:"#7dff9e"}:s>=4?{t:"‚ñ≥ ÂÄôË£ú",c:"#f0d060"}:{t:"‚úï",c:"#4a6a88"};}
function badge(s){var d=scoreLabel(s);return '<span class="score-badge" style="background:'+d.c+'18;color:'+d.c+';border:1px solid '+d.c+'40">'+d.t+'</span>';}

var DATA=null;
var state={sortK:"rs_p2",sortD:"desc",search:"",minRS:0,minVCS:0,minStage:0,selected:null,showP1:false,showP2:true,showP3:true,showP4:true,showAvg:true};

fetch("./data.json?t="+Date.now())
  .then(function(r){if(!r.ok)throw new Error("HTTP "+r.status);return r.json();})
  .then(function(d){DATA=d;render();})
  .catch(function(err){document.getElementById("app").innerHTML='<div class="center-msg"><div style="font-size:36px">‚ö†Ô∏è</div><div style="color:#ff5252">ÂèñÂæóÂ§±Êïó: '+err.message+'</div><button class="btn" onclick="location.reload()">ÂÜçË©¶Ë°å</button></div>';});

function getRows(){
  if(!DATA)return[];
  var rows=(DATA.stocks||[]).filter(function(s){
    if(state.search&&s.ticker.indexOf(state.search.toUpperCase())<0)return false;
    if((s.rs_p2||0)<state.minRS)return false;
    if((s.vcs||0)<state.minVCS)return false;
    if((s.stage2||0)<state.minStage)return false;
    return true;
  });
  var k=state.sortK,d=state.sortD;
  rows.sort(function(a,b){var av=a[k]!=null?a[k]:-999,bv=b[k]!=null?b[k]:-999;return d==="desc"?bv-av:av-bv;});
  return rows;
}
function getRSCols(){
  var cols=[];
  if(state.showP1)cols.push({k:"rs_p1",l:"RS5"});
  if(state.showP2)cols.push({k:"rs_p2",l:"RS21‚òÖ"});
  if(state.showP3)cols.push({k:"rs_p3",l:"RS63"});
  if(state.showP4)cols.push({k:"rs_p4",l:"RS126"});
  if(state.showAvg)cols.push({k:"rs_avg",l:"Avg"});
  return cols;
}
function th(k,label,cls){
  var active=state.sortK===k;
  var arrow=active?(state.sortD==="desc"?" ‚Üì":" ‚Üë"):"";
  return '<th class="'+(cls||"")+(active?" active":"")+'" onclick="sort(\''+k+'\')">'+label+arrow+'</th>';
}

function render(){
  if(!DATA)return;
  var rows=getRows(),rsCols=getRSCols(),market=DATA.market||{};
  var topN=rows.filter(function(r){return(r.score||0)>=8;}).length;
  var midN=rows.filter(function(r){return(r.score||0)>=6&&(r.score||0)<8;}).length;
  var vcsN=rows.filter(function(r){return(r.vcs||0)>=80;}).length;
  var html='';

  html+='<div class="topbar">';
  html+='<div class="logo">Stock<span>Screen</span></div>';
  html+='<div class="meta"><div class="time">'+(DATA.updated_jst||"")+'</div><div>'+DATA.universe_size+'ÈäòÊüÑ ‚Üí '+DATA.total_found+'ÂÄôË£ú</div></div>';
  html+='<input class="search" type="text" placeholder="TickerÊ§úÁ¥¢" value="'+state.search+'" oninput="onSearch(this.value)"/>';
  html+='<div style="display:flex;gap:3px;align-items:center"><span style="font-size:10px;color:#2a4a6a">RS:</span>';
  [["showP1"," 5d"],["showP2","21d‚òÖ"],["showP3","63d"],["showP4","126d"],["showAvg","Avg"]].forEach(function(x){
    var on=state[x[0]];
    html+='<button style="background:'+(on?"rgba(0,229,255,.15)":"#0a1320")+';border:1px solid '+(on?"rgba(0,229,255,.4)":"#0e1c30")+';border-radius:6px;padding:3px 8px;color:'+(on?"#00e5ff":"#2a4a6a")+';font-size:10px;cursor:pointer" onclick="toggle(\''+x[0]+'\')">'+x[1]+'</button>';
  });
  html+='</div><button class="btn" onclick="location.reload()">üîÑ Êõ¥Êñ∞</button></div>';

  html+='<div class="layout"><div class="sidebar">';
  html+='<div class="sidebar-title">„Éï„Ç£„É´„Çø„Éº</div>';
  [{l:"RS P2 ÊúÄ‰Ωé",k:"minRS",v:state.minRS,min:0,max:99,step:5,f:function(v){return v+"+";}},
   {l:"VCS ÊúÄ‰Ωé",k:"minVCS",v:state.minVCS,min:0,max:90,step:5,f:function(v){return v+"+";}},
   {l:"Stage2 ÊúÄ‰Ωé",k:"minStage",v:state.minStage,min:0,max:9,step:1,f:function(v){return v+"/9+";}}
  ].forEach(function(f){
    html+='<div><div class="filter-row"><span class="filter-label">'+f.l+'</span><span class="filter-val">'+f.f(f.v)+'</span></div>';
    html+='<input type="range" min="'+f.min+'" max="'+f.max+'" step="'+f.step+'" value="'+f.v+'" oninput="setFilter(\''+f.k+'\',+this.value)"/></div>';
  });
  html+='<button class="reset-btn" onclick="resetFilters()">„É™„Çª„ÉÉ„Éà</button>';
  if(market.mode){
    html+='<div class="macro"><div class="macro-mode">'+(market.icon||"")+" "+market.mode+'</div>';
    html+='<div class="macro-vix">VIX: '+market.vix+'</div>';
    Object.keys(market.etfs||{}).forEach(function(etf){var d=market.etfs[etf];var ok=d.above&&d.rising;html+='<div class="macro-etf" style="color:'+(ok?"#00e676":"#ff5252")+'">'+(ok?"üü¢":"üî¥")+" "+etf+" $"+d.close+'</div>';});
    html+='</div>';
  }
  html+='<div class="score-legend"><div class="leg-title">„Çπ„Ç≥„Ç¢ÔºàÊúÄÂ§ß10Ôºâ</div>RS‚â•90 +3/‚â•70 +2/‚â•50 +1<br>VCS‚â•80 +3/‚â•60 +1<br>Stage2=9 +2/‚â•7 +1<br>EMA‚â§3% +1</div>';
  html+='</div>';

  html+='<div class="main"><div class="cards">';
  [[rows.length,"Ë°®Á§∫ÈäòÊüÑ","#00e5ff"],[topN,"‚óé ÊúÄÊúâÂäõ","#00ff88"],[midN,"‚óã ÊúâÂäõ","#7dff9e"],[vcsN,"VCS‚â•80","#00ff88"]].forEach(function(x){
    html+='<div class="card"><div class="card-label">'+x[1]+'</div><div class="card-val" style="color:'+x[2]+'">'+x[0]+'</div></div>';
  });
  html+='</div>';

  if(state.selected){
    var s=state.selected;
    html+='<div class="detail"><div class="detail-head"><div><span class="detail-ticker">'+s.ticker+'</span>'+badge(s.score||0)+'</div><button class="detail-close" onclick="closeDetail()">‚úï</button></div>';
    html+='<div class="detail-grid">';
    [
      ["RS P1(5Êó•)",   fmtRS(s.rs_p1),  rsCol(s.rs_p1||0)],
      ["RS P2(21Êó•)‚òÖ", fmtRS(s.rs_p2),  rsCol(s.rs_p2||0)],
      ["RS P3(63Êó•)",  fmtRS(s.rs_p3),  rsCol(s.rs_p3||0)],
      ["RS P4(126Êó•)", fmtRS(s.rs_p4),  rsCol(s.rs_p4||0)],
      ["RS Avg",       fmtRS(s.rs_avg), rsCol(s.rs_avg||0)],
      ["1M„É™„Çø„Éº„É≥",   fmtN(s.m1),      numCol(s.m1||0)],
      ["3M„É™„Çø„Éº„É≥",   fmtN(s.m3),      numCol(s.m3||0)],
      ["6M„É™„Çø„Éº„É≥",   fmtN(s.m6),      numCol(s.m6||0)],
      ["Stage2",   (s.stage2||0)+"/9",  (s.stage2||0)>=8?"#00e5ff":"#f0d060"],
      ["VCS",      s.vcs!=null?s.vcs:"‚Äî", vcsCol(s.vcs||0)],
      ["EMA Low%", s.ema_low_pct!=null?fmtV(s.ema_low_pct)+"%":"‚Äî", emaCol(s.ema_low_pct!=null?s.ema_low_pct:99)],
      ["ATR%50SMA",s.atr_sma50!=null?fmtV(s.atr_sma50):"‚Äî",        atrCol(s.atr_sma50!=null?s.atr_sma50:99)],
      ["ADR%",     s.adr?fmtV(s.adr)+"%":"‚Äî", "#ddeeff"],
      ["Ê†™‰æ°",     "$"+(s.close||0),    "#ddeeff"],
      ["ÊêçÂàá„Çä",   "$"+(s.stop||0),     "#ff5252"],
      ["TP1(+10%)","$"+(s.tp1||0),     "#00ff88"],
      ["TP2(+20%)","$"+(s.tp2||0),     "#00e5ff"],
    ].forEach(function(c){html+='<div class="detail-cell"><div class="detail-cell-label">'+c[0]+'</div><div class="detail-cell-val" style="color:'+c[2]+'">'+c[1]+'</div></div>';});
    html+='</div></div>';
  }

  html+='<div class="tbl-wrap"><div class="tbl-scroll"><table><thead><tr>';
  html+=th("rs_p2","RS‚òÖ","");
  html+='<th class="left">Ticker</th>';
  rsCols.forEach(function(c){html+=th(c.k,c.l);});
  [["m1","1M%"],["m3","3M%"],["m6","6M%"],["stage2","Stage2"],["vcs","VCS"],
   ["ema_low_pct","EMA%"],["atr_sma50","ATR/SMA"],
   ["adr","ADR%"],["close","Price"],["score","Score"]
  ].forEach(function(c){html+=th(c[0],c[1]);});
  html+='<th>Ë©ï‰æ°</th></tr></thead><tbody>';

  if(rows.length===0){
    html+='<tr><td colspan="20" style="text-align:center;padding:40px;color:#2a4a6a">Êù°‰ª∂„Å´Âêà„ÅÜÈäòÊüÑ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
  }else{
    rows.forEach(function(d){
      var isSel=state.selected&&state.selected.ticker===d.ticker;
      html+='<tr class="'+(isSel?"sel":"")+'" onclick="selectRow(\''+d.ticker+'\')">';
      var rc=rsCol(d.rs_p2||0);
      html+='<td style="text-align:center"><span class="rs-badge" style="background:'+rc+'15;color:'+rc+';border:1px solid '+rc+'35">'+fmtRS(d.rs_p2)+'</span></td>';
      html+='<td class="left"><span style="font-family:sans-serif;font-weight:800;color:#00e5ff;font-size:14px">'+d.ticker+'</span></td>';
      rsCols.forEach(function(c){
        var v=d[c.k];
        if(v==null){html+='<td style="color:#2a4a6a">‚Äî</td>';return;}
        var col=rsCol(v),isSort=state.sortK===c.k;
        html+='<td><span style="color:'+col+';font-weight:'+(v>=80?700:400)+';background:'+(isSort?col+'14':"transparent")+';border-radius:3px;padding:'+(isSort?"1px 5px":0)+'">'+fmtRS(v)+'</span></td>';
      });
      html+='<td style="color:'+numCol(d.m1||0)+'">'+fmtN(d.m1)+'</td>';
      html+='<td style="color:'+numCol(d.m3||0)+'">'+fmtN(d.m3)+'</td>';
      html+='<td style="color:'+numCol(d.m6||0)+'">'+fmtN(d.m6)+'</td>';
      var s2=d.stage2||0;
      html+='<td style="color:'+(s2>=8?"#00e5ff":s2>=7?"#f0d060":"#ff8a80")+'">'+s2+'/9</td>';
      html+='<td><span style="font-weight:700;color:'+vcsCol(d.vcs||0)+'">'+(d.vcs!=null?d.vcs:"‚Äî")+'</span></td>';
      var ep=d.ema_low_pct;
      html+='<td style="color:'+emaCol(ep!=null?ep:99)+';font-weight:600">'+(ep!=null?fmtV(ep)+"%":"‚Äî")+'</td>';
      var ap=d.atr_sma50;
      html+='<td style="color:'+atrCol(ap!=null?ap:99)+';font-weight:600">'+(ap!=null?fmtV(ap):"‚Äî")+'</td>';
      html+='<td style="color:#607d8b">'+(d.adr?fmtV(d.adr)+"%":"‚Äî")+'</td>';
      html+='<td style="color:#ddeeff;font-weight:600">$'+(d.close||0)+'</td>';
      html+='<td style="font-family:sans-serif;font-weight:700;color:#ddeeff">'+(d.score||0)+'</td>';
      html+='<td>'+badge(d.score||0)+'</td></tr>';
    });
  }
  html+='</tbody></table></div></div>';
  html+='<div class="footer"><span>RS=percentrank(TICKER/SPY) | EMA%=(close-EMA21)/EMA21 | ATR/SMA=(close-SMA50)√ó100/ATR14 | Ë°å„ÇØ„É™„ÉÉ„ÇØ‚ÜíË©≥Á¥∞</span>';
  html+='<span>'+rows.length+'‰ª∂ / '+DATA.total_found+'ÂÄôË£ú / '+DATA.universe_size+'„Çπ„Ç≠„É£„É≥</span></div>';
  html+='</div></div>';
  document.getElementById("app").innerHTML=html;
}

function sort(k){if(state.sortK===k)state.sortD=state.sortD==="desc"?"asc":"desc";else{state.sortK=k;state.sortD="desc";}render();}
function onSearch(v){state.search=v;render();}
function setFilter(k,v){state[k]=v;render();}
function resetFilters(){state.search="";state.minRS=0;state.minVCS=0;state.minStage=0;render();}
function toggle(k){state[k]=!state[k];render();}
function selectRow(ticker){var rows=getRows();var found=null;for(var i=0;i<rows.length;i++){if(rows[i].ticker===ticker){found=rows[i];break;}}state.selected=(state.selected&&state.selected.ticker===ticker)?null:found;render();}
function closeDetail(){state.selected=null;render();}
</script>
</body>
</html>
